---
title: Cè¿›é˜¶åŠ¨æ€å†…å­˜ç®¡ç†-2
tags: C
categories:
  - - åç«¯
    - C
description: Cè¯­è¨€åŠ¨æ€å†…å­˜ç®¡ç†---ç»­
cover: https://cdn.jsdelivr.net/gh/webyang-male/CDN/imgs/bg_c.png
abbrlink: 45073
date: 2021-06-24 09:18:57
---

### ç»å…¸ç¬”è¯•é¢˜

##### é¢˜ç›®2ï¼š

```c
char *GetMemory(void)
{
	char p[] = "hello world";
	return p;
}

void Test(void)
{
	char *str = NULL;
	str = GetMemory();
	printf(str);
}

int main()
{
	Test();
	return 0;
}
//æ‰“å°éšæœºå€¼
```

è¿”å›æ ˆç©ºé—´åœ°å€é—®é¢˜ï¼Œéæ³•è®¿é—®å†…å­˜é‡æŒ‡é’ˆ

##### é¢˜ç›®3ï¼š

````c
void GetMemory(char **p, int num)
{
	*p = (char *)malloc(num);
}
void Test(void)
{
	char *str = NULL;
	GetMemory(&str, 100);
	strcpy(str, "hello");
	printf(str);
}
int main()
{
	Test();
	return 0;
}
````

**æ”¹æ­£:**

```c
//å¿˜è®°é‡Šæ”¾åŠ¨æ€å¼€è¾Ÿçš„å†…å­˜ï¼Œå¯¼è‡´å†…å­˜æ³„æ¼

void GetMemory(char **p, int num)
{
	*p = (char *)malloc(num);
}
void Test(void)
{
	char *str = NULL;
	GetMemory(&str, 100);
	strcpy(str, "hello");
	printf(str);
	//æ”¹
	free(str);
	str = NULL;
}
int main()
{
	Test();
	return 0;
}
```

##### é¢˜ç›®4ï¼š

````c
void Test(void)
{
	char *str = (char *)malloc(100);
	strcpy(str, "hello");
	free(str);
	if (str != NULL)
	{
		strcpy(str, "world");
		printf(str);
	}
}

int main()
{
	Test();
	return 0;
}
````

**æ”¹æ­£:**

````c
void Test(void)
{
	char *str = (char *)malloc(100);
	strcpy(str, "hello");
	free(str);//freeé‡Šæ”¾stræŒ‡å‘çš„ç©ºé—´åï¼Œå¹¶ä¸ä¼šæŠŠstrç½®ä¸ºNULL
	str = NULL;

	if (str != NULL)
	{
		strcpy(str, "world");
		printf(str);
	}
}

int main()
{
	Test();
	return 0;
}
````

### C/C++ç¨‹åºçš„å†…å­˜å¼€è¾Ÿ

![åŠ¨æ€å†…å­˜ç®¡ç†](https://gitee.com/initzzy/blog-image/raw/master/%E7%AC%AC5%E8%8A%82-%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.jpg)_åŠ¨æ€å†…å­˜ç®¡ç†_

ğŸ’ <font style="color:skyblue;">æ•°æ®æ®µä¹Ÿç§°é™æ€åŒº</font>

##### C/C++ç¨‹åºå†…å­˜åˆ†é…çš„å‡ ä¸ªåŒºåŸŸï¼š

> 1. æ ˆåŒºï¼ˆstackï¼‰ï¼šåœ¨æ‰§è¡Œå‡½æ•°æ—¶ï¼Œå‡½æ•°å†…å±€éƒ¨å˜é‡çš„å­˜å‚¨å•å…ƒéƒ½å¯ä»¥åœ¨æ ˆä¸Šåˆ›å»ºï¼Œå‡½æ•°æ‰§è¡Œç»“æŸæ—¶è¿™äº›
> å­˜å‚¨å•å…ƒè‡ªåŠ¨è¢«é‡Šæ”¾ã€‚æ ˆå†…å­˜åˆ†é…è¿ç®—å†…ç½®äºå¤„ç†å™¨çš„æŒ‡ä»¤é›†ä¸­ï¼Œæ•ˆç‡å¾ˆé«˜ï¼Œä½†æ˜¯åˆ†é…çš„å†…å­˜å®¹é‡æœ‰
> é™ã€‚ æ ˆåŒºä¸»è¦å­˜æ”¾è¿è¡Œå‡½æ•°è€Œåˆ†é…çš„å±€éƒ¨å˜é‡ã€å‡½æ•°å‚æ•°ã€è¿”å›æ•°æ®ã€è¿”å›åœ°å€ç­‰ã€‚
> 2. å †åŒºï¼ˆheapï¼‰ï¼šä¸€èˆ¬ç”±ç¨‹åºå‘˜åˆ†é…é‡Šæ”¾ï¼Œ è‹¥ç¨‹åºå‘˜ä¸é‡Šæ”¾ï¼Œç¨‹åºç»“æŸæ—¶å¯èƒ½ç”±OSå›æ”¶ ã€‚åˆ†é…æ–¹å¼ç±»ä¼¼
> äºé“¾è¡¨ã€‚
> 3. æ•°æ®æ®µï¼ˆé™æ€åŒºï¼‰ï¼ˆstaticï¼‰å­˜æ”¾å…¨å±€å˜é‡ã€é™æ€æ•°æ®ã€‚ç¨‹åºç»“æŸåç”±ç³»ç»Ÿé‡Šæ”¾ã€‚
> 4. ä»£ç æ®µï¼šå­˜æ”¾å‡½æ•°ä½“ï¼ˆç±»æˆå‘˜å‡½æ•°å’Œå…¨å±€å‡½æ•°ï¼‰çš„äºŒè¿›åˆ¶ä»£ç ã€‚

æ ¹æ®ä¸Šå›¾ï¼Œç†è§£`static`å…³é”®å­—ä¿®é¥°å±€éƒ¨å˜é‡ï¼š

 å®é™…ä¸Šæ™®é€šçš„å±€éƒ¨å˜é‡æ˜¯åœ¨æ ˆåŒºåˆ†é…ç©ºé—´çš„ï¼Œæ ˆåŒºçš„ç‰¹ç‚¹æ˜¯åœ¨ä¸Šé¢åˆ›å»ºçš„å˜é‡å‡ºäº†ä½œç”¨åŸŸå°±é”€æ¯ã€‚
		ä½†æ˜¯è¢«staticä¿®é¥°çš„å˜é‡å­˜æ”¾åœ¨æ•°æ®æ®µï¼ˆé™æ€åŒºï¼‰ï¼Œæ•°æ®æ®µçš„ç‰¹ç‚¹æ˜¯åœ¨ä¸Šé¢åˆ›å»ºçš„å˜é‡ï¼Œç›´åˆ°ç¨‹åºç»“æŸæ‰é”€æ¯æ‰€ä»¥ç”Ÿå‘½å‘¨æœŸå˜é•¿ã€‚

### æŸ”æ€§æ•°ç»„ï¼ˆflexible arrayï¼‰

> C99 ä¸­ï¼Œç»“æ„ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ å…è®¸æ˜¯æœªçŸ¥å¤§å°çš„æ•°ç»„ï¼Œè¿™å°±å«åš **æŸ”æ€§æ•°ç»„** æˆå‘˜ã€‚

ä¸¾ğŸŒ°:

````c
//å¸¸è§„å†™æ³•
//struct S
//{
//	int n;
//	int arr[10];
//};

struct S
{
	int n;
	int arr[];//æœªçŸ¥å¤§å°çš„
};

struct S
{
	int n;
	int arr[0];//æœªçŸ¥å¤§å°çš„-æŸ”æ€§æ•°ç»„æˆå‘˜-æ•°ç»„çš„å¤§å°æ˜¯å¯ä»¥è°ƒæ•´çš„
};
````

#### æŸ”æ€§æ•°ç»„çš„ç‰¹ç‚¹

- ç»“æ„ä¸­çš„æŸ”æ€§æ•°ç»„æˆå‘˜å‰é¢å¿…é¡»è‡³å°‘ä¸€ä¸ªå…¶ä»–æˆå‘˜ã€‚
- sizeof è¿”å›çš„è¿™ç§ç»“æ„å¤§å°ä¸åŒ…æ‹¬æŸ”æ€§æ•°ç»„çš„å†…å­˜ã€‚
- åŒ…å«æŸ”æ€§æ•°ç»„æˆå‘˜çš„ç»“æ„ç”¨malloc ()å‡½æ•°è¿›è¡Œå†…å­˜çš„åŠ¨æ€åˆ†é…ï¼Œå¹¶ä¸”åˆ†é…çš„å†…å­˜åº”è¯¥å¤§äºç»“æ„çš„å¤§å°ï¼Œä»¥é€‚åº”æŸ”æ€§æ•°ç»„çš„é¢„æœŸå¤§å°ã€‚

````c
struct S
{
	int n;
	int arr[0];//æœªçŸ¥å¤§å°çš„-æŸ”æ€§æ•°ç»„æˆå‘˜-æ•°ç»„çš„å¤§å°æ˜¯å¯ä»¥è°ƒæ•´çš„
};

int main()
{
	struct S s;
  //åœ¨åŒ…å«æŸ”æ€§æ•°ç»„çš„ç»“æ„ä½“å¤§å°ä¸­,ä¸è®¡ç®—æŸ”æ€§æ•°ç»„
	printf("%d\n",sizeof(s));//4
	return 0;
}
````

#### æŸ”æ€§æ•°ç»„çš„ä½¿ç”¨

`````c
struct S
{
	int n;
	int arr[0];//æœªçŸ¥å¤§å°çš„-æŸ”æ€§æ•°ç»„æˆå‘˜-æ•°ç»„çš„å¤§å°æ˜¯å¯ä»¥è°ƒæ•´çš„
};

int main()
{
	//struct S s;
	//printf("%d\n", sizeof(s));//
	struct S* ps = (struct S*)malloc(sizeof(struct S)+5*sizeof(int));
	ps->n = 100;

	int i = 0;
	for (i = 0; i < 5; i++)
	{
		ps->arr[i] = i;//0 1 2 3 4
	}
	struct S* ptr = realloc(ps, 44);
	if (ptr != NULL)
	{
		ps = ptr;
	}
	for (i = 5; i < 10; i++)
	{
		ps->arr[i] = i;
	}

	for (i = 0; i < 10; i++)
	{
		printf("%d ", ps->arr[i]);
	}

	//é‡Šæ”¾
	free(ps);
	ps = NULL;

	return 0;
}
`````

````C
//ä»£ç 1
int main(){
	int i = 0;
	type_a *p = (type_a*)malloc(sizeof(type_a)+100 * sizeof(int));
	//ä¸šåŠ¡å¤„ç†
	p->i = 100;
	for (i = 0; i<100; i++)
	{
		p->a[i] = i;
	}
	free(p);
}
````

è¿™æ ·æŸ”æ€§æ•°ç»„æˆå‘˜aï¼Œç›¸å½“äºè·å¾—äº†100ä¸ªæ•´å‹å…ƒç´ çš„è¿ç»­ç©ºé—´ã€‚

#### æŸ”æ€§æ•°ç»„çš„ä¼˜åŠ¿

ä¸Šè¿°çš„type_a ç»“æ„ä¹Ÿå¯ä»¥è®¾è®¡ä¸ºï¼š

```c
int main(){
	//ä»£ç 2
	typedef struct st_type
	{
		int i;
		int *p_a;
	}type_a;
  
	type_a *p = malloc(sizeof(type_a));
	p->i = 100;
	p->p_a = (int *)malloc(p->i*sizeof(int));
  
	//ä¸šåŠ¡å¤„ç†
	for (i = 0; i < 100; i++)
	{
		p->p_a[i] = i;
	}
  
	//é‡Šæ”¾ç©ºé—´
	free(p->p_a);
	p->p_a = NULL;
	free(p);
	p = NULL;
}
```

ä¸Šè¿° ä»£ç 1 å’Œ ä»£ç 2 å¯ä»¥å®ŒæˆåŒæ ·çš„åŠŸèƒ½ï¼Œä½†æ˜¯ æ–¹æ³•1 çš„å®ç°æœ‰ä¸¤ä¸ªå¥½å¤„ã€‚

<font style="color:#3eaf7c;">ç¬¬ä¸€ä¸ªå¥½å¤„æ˜¯ï¼šæ–¹ä¾¿å†…å­˜é‡Šæ”¾</font>

> å¦‚æœæˆ‘ä»¬çš„ä»£ç æ˜¯åœ¨ä¸€ä¸ªç»™åˆ«äººç”¨çš„å‡½æ•°ä¸­ï¼Œä½ åœ¨é‡Œé¢åšäº†äºŒæ¬¡å†…å­˜åˆ†é…ï¼Œå¹¶æŠŠæ•´ä¸ªç»“æ„ä½“è¿”å›ç»™ç”¨æˆ·ã€‚ç”¨æˆ·è°ƒç”¨freeå¯ä»¥é‡Šæ”¾ç»“æ„ä½“ï¼Œä½†æ˜¯ç”¨æˆ·å¹¶ä¸çŸ¥é“è¿™ä¸ªç»“æ„ä½“å†…çš„æˆå‘˜ä¹Ÿéœ€è¦freeï¼Œæ‰€ä»¥ä½ ä¸èƒ½æŒ‡æœ›ç”¨æˆ·æ¥å‘ç°è¿™ä¸ªäº‹ã€‚æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬æŠŠç»“æ„ä½“çš„å†…å­˜ä»¥åŠå…¶æˆå‘˜è¦çš„å†…å­˜ä¸€æ¬¡æ€§åˆ†é…å¥½äº†ï¼Œå¹¶è¿”å›ç»™ç”¨æˆ·ä¸€ä¸ªç»“æ„ä½“æŒ‡é’ˆï¼Œç”¨æˆ·åšä¸€æ¬¡freeå°±å¯ä»¥æŠŠæ‰€æœ‰çš„å†…å­˜ä¹Ÿç»™é‡Šæ”¾æ‰ã€‚

<font style="color:#3eaf7c;">ç¬¬äºŒä¸ªå¥½å¤„æ˜¯ï¼šè¿™æ ·æœ‰åˆ©äºè®¿é—®é€Ÿåº¦</font>

> è¿ç»­çš„å†…å­˜æœ‰ç›Šäºæé«˜è®¿é—®é€Ÿåº¦ï¼Œä¹Ÿæœ‰ç›Šäºå‡å°‘å†…å­˜ç¢ç‰‡ã€‚ï¼ˆå…¶å®ï¼Œæˆ‘ä¸ªäººè§‰å¾—ä¹Ÿæ²¡å¤šé«˜äº†ï¼Œåæ­£ä½ è·‘ä¸äº†è¦ç”¨åšåç§»é‡çš„åŠ æ³•æ¥å¯»å€ï¼‰

ğŸ“–**æ‰©å±•é˜…è¯»ï¼š**

#### [Cè¯­è¨€ç»“æ„ä½“é‡Œçš„æ•°ç»„å’ŒæŒ‡é’ˆ](https://coolshell.cn/articles/11377.html)

### å®æˆ˜é€šè®¯å½•

æºç åœ°å€:

